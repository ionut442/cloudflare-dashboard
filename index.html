<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flight Dashboard</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; padding: 16px; }
    .top { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; }
    .city { font-weight:700; font-size:16px; margin-bottom:6px; }
    .code { opacity:.7; font-size:12px; margin-bottom:10px; }
    .price { font-size:24px; font-weight:800; margin: 8px 0 10px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 8px 0; }
    .btn { cursor:pointer; border:1px solid #111; background:#111; color:#fff; padding:8px 10px; border-radius:10px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .pill { display:inline-block; font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; }
    .muted { opacity:.7; font-size:12px; }
    .ok { color: #0a7; }
    .err { color: #b00; }
  </style>
</head>
<body>
  <div class="top">
    <h2 style="margin:0;">Flight Dashboard</h2>
    <button class="btn" id="refreshBtn">Refresh prices</button>
    <span class="muted" id="status"></span>
    <a href="/output.html" style="margin-left:auto;">Output page</a>
  </div>

  <div class="grid" id="grid"></div>

  <script>
    const grid = document.getElementById("grid");
    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");

    refreshBtn.addEventListener("click", () => load());

    function money(v, cur="EUR") {
      if (v == null) return "--";
      return `${v} ${cur}`;
    }

    async function load() {
      statusEl.textContent = "Loading...";
      // this will exist once we add Functions. For now it will 404 - that's OK.
      const res = await fetch("/api/airports", { cache: "no-store" });
      if (!res.ok) {
        statusEl.textContent = "API not set yet (next step).";
        return;
      }
      const data = await res.json();
      if (!data.ok) {
        statusEl.textContent = "Error loading airports";
        return;
      }
      statusEl.textContent = `Loaded ${data.total} cities`;
      render(data.airports);
    }

    function render(airports) {
      grid.innerHTML = "";

      for (const a of airports) {
        const price = a.cheapest?.price ?? null;
        const cur = a.cheapest?.currency ?? "EUR";
        const updated = a.cheapest?.updated_at ?? null;

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="city">${escapeHtml(a.city_name).toUpperCase()}</div>
          <div class="code">${escapeHtml(a.iata_city_code)} <span class="pill">${escapeHtml(a.country)}</span></div>

          <div class="price">${money(price, cur)}</div>
          <div class="muted">${updated ? ("Updated: " + escapeHtml(updated)) : "Not updated yet"}</div>

          <div class="row" style="margin-top:10px;">
            <label><input type="radio" name="n_${a.iata_city_code}" value="3" checked> 3 night</label>
            <label><input type="radio" name="n_${a.iata_city_code}" value="5-7"> 5-7 night</label>
          </div>

          <div class="row">
            <button class="btn" data-to="${escapeAttr(a.iata_city_code)}">Send Request</button>
            <span class="muted" id="msg_${escapeAttr(a.iata_city_code)}"></span>
          </div>
        `;

        const btn = card.querySelector("button.btn");
        btn.addEventListener("click", async () => {
          const to = btn.getAttribute("data-to");
          const nights = (card.querySelector(`input[name="n_${to}"]:checked`) || {}).value || "3";
          await sendRequest(to, nights);
        });

        grid.appendChild(card);
      }
    }

    async function sendRequest(to_code, nights_pref) {
      const msg = document.getElementById("msg_" + to_code);
      msg.textContent = "Sending...";
      msg.className = "muted";

      const res = await fetch("/api/request", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ to_code, nights_pref })
      });

      if (!res.ok) {
        msg.textContent = "API not set yet (next step).";
        msg.className = "muted err";
        return;
      }

      const data = await res.json();
      if (!data.ok) {
        msg.textContent = data.error || "Failed";
        msg.className = "muted err";
        return;
      }

      msg.textContent = "Queued: " + data.id;
      msg.className = "muted ok";
    }

    function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g, "&quot;"); }

    load();
  </script>
</body>
</html>